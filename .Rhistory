df <- data.frame(
SessionID = integer(),
UserID = integer(),
EventType = character(),
Outcome = character(),
stringsAsFactors = FALSE
)
# Simulate session-level user journeys
for (sid in 1:n_sessions) {
# Random session length
n_events <- sample(3:6, 1)
path <- character(n_events)
# All sessions start with a page view
path[1] <- "page_view"
# Simulate navigation behavior
for (i in 2:n_events) {
prev <- path[i - 1]
if (prev == "page_view") {
path[i] <- sample(c("product_view", "logout"), 1, prob = c(0.7, 0.3))
} else if (prev == "product_view") {
path[i] <- sample(c("add_to_cart", "logout"), 1, prob = c(0.6, 0.4))
} else if (prev == "add_to_cart") {
path[i] <- sample(c("checkout", "logout"), 1, prob = c(0.7, 0.3))
} else if (prev == "checkout") {
path[i] <- sample(c("purchase", "no_purchase"), 1, prob = c(0.6, 0.4))
} else if (prev == "logout") {
path[i] <- "no_purchase"
}
}
# Define session outcome based on final state
outcome <- ifelse(path[n_events] == "purchase", "purchase", "no_purchase")
# Append session to dataset
df <- rbind(df, data.frame(SessionID = sid,
UserID = sid,
EventType = path,
Outcome = outcome,
stringsAsFactors = FALSE))
}
# Number of simulated sessions
n_sessions <- 500
# Possible interaction events
events <- c("page_view", "product_view", "add_to_cart", "checkout", "logout")
# Initialize empty dataset
df <- data.frame(SessionID = integer(),
UserID = integer(),
EventType = character(),
Outcome = character(),
stringsAsFactors = FALSE)
# Simulate session-level user journeys
for (sid in 1:n_sessions) {
# Random session length
n_events <- sample(3:6, 1)
path <- character(n_events)
# All sessions start with a page view
path[1] <- "page_view"
# Simulate navigation behavior
for (i in 2:n_events) {
prev <- path[i - 1]
if (prev == "page_view") {
path[i] <- sample(c("product_view", "logout"), 1, prob = c(0.7, 0.3))
} else if (prev == "product_view") {
path[i] <- sample(c("add_to_cart", "logout"), 1, prob = c(0.6, 0.4))
} else if (prev == "add_to_cart") {
path[i] <- sample(c("checkout", "logout"), 1, prob = c(0.7, 0.3))
} else if (prev == "checkout") {
path[i] <- sample(c("purchase", "no_purchase"), 1, prob = c(0.6, 0.4))
} else if (prev == "logout") {
path[i] <- "no_purchase"
}
}
# Define session outcome based on final state
outcome <- ifelse(path[n_events] == "purchase", "purchase", "no_purchase")
# Append session to dataset
df <- rbind(df, data.frame(SessionID = sid,
UserID = sid,
EventType = path,
Outcome = outcome,
stringsAsFactors = FALSE))
}
# Build transitions table
transitions <- df %>%
group_by(SessionID) %>%
mutate(next_event = lead(EventType)) %>%
ungroup() %>%
# Replace final NA with outcome to create absorbing states
mutate(next_event = ifelse(is.na(next_event), Outcome, next_event))
# Fit Markov chain using MLE
mc <- markovchainFit(data = transitions[, c("EventType", "next_event")], method = "mle")$estimate
# ----------------------------------------
# 4. Define absorbing states
# ----------------------------------------
tm <- mc@transitionMatrix
# Purchase is absorbing
tm["purchase", ] <- 0
tm["purchase", "purchase"] <- 1
# No purchase is absorbing
tm["no_purchase", ] <- 0
tm["no_purchase", "no_purchase"] <- 1
mc_abs <- new("markovchain", states = mc@states, transitionMatrix = tm)
# Compute absorption probabilities
abs_probs <- absorptionProbabilities(mc_abs)
# Absorption rate dataframe
abs_probs_df <- as.data.frame(abs_probs) %>%
rownames_to_column("Event") %>%
pivot_longer(-Event, names_to = "Outcome", values_to = "Probability")
# Plot probability of purchase by event
ggplot(abs_probs_df %>%
mutate(Event = fct_reorder(Event, Probability, .fun = max)),
aes(x = Event, y = Probability, fill = Outcome)) +
geom_col() +
coord_flip() +
labs(title = "Probability of Ending in Purchase or No Purchase by Event",
x = "Event",
y = "Probability") +
scale_fill_manual(values = c("purchase" = "steelblue", "no_purchase" = "tomato")) +
theme_minimal()
abs_probs_df %>%
filter(Outcome == "purchase") %>%
arrange(desc(Probability))
# Create explicit event-to-event transitions within each session
df_flow <- df %>%
group_by(SessionID) %>%
mutate(next_event = lead(EventType)) %>%
ungroup() %>%
mutate(next_event = ifelse(is.na(next_event), Outcome, next_event))
# Aggregate transitions across all sessions
flow_counts <- df_flow %>%
group_by(EventType, next_event) %>%
summarise(Freq = n(), .groups = "drop")
# Plot the user flow as an alluvial diagram. This highlights dominant paths and where users drop off
ggplot(flow_counts, aes(axis1 = EventType, axis2 = next_event, y = Freq)) +
geom_alluvium(aes(fill = next_event), width = 1/12) +
geom_stratum(width = 1/12, fill = "grey", color = "black") +
geom_text(stat = "stratum", aes(label = after_stat(stratum))) +
scale_x_discrete(limits = c("Current Event", "Next Event")) +
labs(title = "User Flow and Drop-off Paths",
y = "Number of Users") +
theme_minimal()
# Build session-level paths
paths <- df %>%
group_by(SessionID) %>%
summarise(path = paste(EventType, collapse = "/"),
Outcome = last(Outcome),
.groups = "drop") %>%
mutate(path = paste(path, Outcome, sep = "/"))
path_counts <- paths %>%
count(path, name = "value")
# Prepare sunburst hierarchy
sunburst_data <- path_counts %>%
mutate(parts = strsplit(path, "/")) %>%
rowwise() %>%
mutate(labels = list(parts[[1]]),
values = list(rep(value, length(parts[[1]])))) %>%
unnest(c(labels, values)) %>%
group_by(path) %>%
mutate(id = paste0(path, "_", row_number()),
parent_id = lag(id)) %>%
ungroup()
plot_ly(ids = sunburst_data$id,
labels = sunburst_data$labels,
parents = sunburst_data$parent_id,
values = sunburst_data$values,
type = "sunburst",
branchvalues = "total")
sunburst_data$id
sunburst_data$labels
plot_ly(ids = sunburst_data$id,
labels = sunburst_data$id,
parents = sunburst_data$parent_id,
values = sunburst_data$values,
type = "sunburst",
branchvalues = "total")
sunburst_data$parent_id
paths
path_counts
sunburst_data
plot_ly(ids = sunburst_data$id,
labels = sunburst_data$labels,
parents = sunburst_data$parent_id,
values = sunburst_data$values,
type = "sunburst",
branchvalues = "total")
sunburst_data$values
sunburst_data$labels
path_counts
paths
paths
path_counts
sunburst_data
sunburst_data
paths <- df %>%
filter(!is.na(EventType), EventType != "") %>%   # <-- critical
group_by(SessionID) %>%
summarise(
path = paste(EventType, collapse = "/"),
Outcome = last(Outcome),
.groups = "drop"
) %>%
mutate(path = paste(path, Outcome, sep = "/"))
paths
any(grepl("//", paths$path))
plot_ly(
data = path_counts,
type = "sunburst",
ids = ~path,
labels = ~basename(path),
parents = ~dirname(path),
values = ~value
)
# Build session-level paths
paths <- df %>%
filter(!is.na(EventType), EventType != "") %>%   # <-- critical
group_by(SessionID) %>%
summarise(
path = paste(EventType, collapse = "/"),
Outcome = last(Outcome),
.groups = "drop"
) %>%
mutate(path = paste(path, Outcome, sep = "/"))
path_counts <- paths %>%
count(path, name = "value")
# Prepare sunburst hierarchy
sunburst_data <- path_counts %>%
mutate(
labels = sub(".*/", "", path),
parents = ifelse(
grepl("/", path),
sub("/[^/]+$", "", path),
""
)
)
plot_ly(
sunburst_data,
type = "sunburst",
ids = ~path,
labels = ~labels,
parents = ~parents,
values = ~value
)
sunburst_data
# Build session-level paths
paths <- df %>%
filter(!is.na(EventType), EventType != "") %>%   # <-- critical
group_by(SessionID) %>%
summarise(
path = paste(EventType, collapse = "/"),
Outcome = last(Outcome),
.groups = "drop"
) %>%
mutate(path = paste(path, Outcome, sep = "/"))
path_counts <- paths %>%
count(path, name = "value")
# Prepare sunburst hierarchy
sunburst_data <- path_counts %>%
mutate(
ids = path,
labels = sub(".*/", "", path),
parents = ifelse(
grepl("/", path),
sub("/[^/]+$", "", path),
""
)
)
setdiff(unique(sunburst_data$parents), c("", sunburst_data$ids))
# Build session-level paths
paths <- df %>%
filter(!is.na(EventType), EventType != "") %>%   # <-- critical
group_by(SessionID) %>%
summarise(
path = paste(EventType, collapse = "/"),
Outcome = last(Outcome),
.groups = "drop"
) %>%
mutate(path = paste(path, Outcome, sep = "/"))
path_counts <- paths %>%
count(path, name = "value")
# Prepare sunburst hierarchy
sunburst_data <- path_counts %>%
mutate(
ids = path,
labels = sub(".*/", "", path),
parents = ifelse(
grepl("/", path),
sub("/[^/]+$", "", path),
""
)
)
library(plotly)
plot_ly(
sunburst_data,
type = "sunburst",
ids = ~ids,
labels = ~labels,
parents = ~parents,
values = ~value
)
sunburst_data
colSums(is.na(sunburst_data[, c("ids", "labels", "parents", "value")]))
sunburst_data %>% filter(parents == "")
# Build session-level paths
paths <- df %>%
filter(!is.na(EventType), EventType != "") %>%   # <-- critical
group_by(SessionID) %>%
summarise(
path = paste(EventType, collapse = "/"),
Outcome = last(Outcome),
.groups = "drop"
) %>%
mutate(path = paste(path, Outcome, sep = "/"))
all_paths <- unique(unlist(
lapply(strsplit(path_counts$path, "/"), function(x)
sapply(seq_along(x), function(i)
paste(x[1:i], collapse = "/")
)
)
))
sunburst_data <- data.frame(path = all_paths) %>%
left_join(path_counts, by = "path") %>%
mutate(
value = ifelse(is.na(value), 0, value),
ids = path,
labels = sub(".*/", "", path),
parents = ifelse(
grepl("/", path),
sub("/[^/]+$", "", path),
""
)
)
library(plotly)
plot_ly(
sunburst_data,
type = "sunburst",
ids = ~ids,
labels = ~labels,
parents = ~parents,
values = ~value
)
# Build session-level paths
paths <- df %>%
filter(!is.na(EventType), EventType != "") %>%
group_by(SessionID) %>%
summarise(
event_path = paste(EventType, collapse = "/"),
outcome = last(Outcome),
.groups = "drop"
)
paths <- paths %>%
mutate(
event_path = gsub("/?(purchase|no_purchase)$", "", event_path)
)
paths <- paths %>%
mutate(
full_path = paste(event_path, outcome, sep = "/")
)
path_counts <- paths %>% count(path, name = "value")
paths
paths <- df %>%
filter(!is.na(EventType), EventType != "") %>%
group_by(SessionID) %>%
summarise(
event_path = paste(EventType, collapse = "/"),
outcome = last(Outcome),
.groups = "drop"
)
paths <- paths %>%
mutate(
event_path = gsub("/?(purchase|no_purchase)$", "", event_path)
)
paths <- paths %>%
mutate(
full_path = paste(event_path, outcome, sep = "/")
)
path_counts <- paths %>%
count(full_path, name = "value")
all_paths <- unique(unlist(
lapply(strsplit(path_counts$full_path, "/"), function(x)
sapply(seq_along(x), function(i)
paste(x[1:i], collapse = "/")
)
)
))
sunburst_data <- data.frame(path = all_paths) %>%
left_join(path_counts, by = c("path" = "full_path")) %>%
mutate(
value = ifelse(is.na(value), 0, value),
ids = path,
labels = sub(".*/", "", path),
parents = ifelse(
grepl("/", path),
sub("/[^/]+$", "", path),
""
)
)
library(plotly)
plot_ly(
sunburst_data,
type = "sunburst",
ids = ~ids,
labels = ~labels,
parents = ~parents,
values = ~value
)
sunburst_data <- sunburst_data %>%
mutate(
is_outcome = labels %in% c("purchase", "no_purchase")
)
library(plotly)
plot_ly(
sunburst_data,
type = "sunburst",
ids = ~ids,
labels = ~labels,
parents = ~parents,
values = ~value
)
plot_ly(
sunburst_data,
type = "sunburst",
ids = ~ids,
labels = ~labels,
parents = ~parents,
values = ~value,
marker = list(
colors = ifelse(
sunburst_data$is_outcome,
ifelse(sunburst_data$labels == "purchase", "#2ca02c", "#d62728"),
"#1f77b4"
)
)
)
funnel_steps <- c(
"page_view",
"product_view",
"add_to_cart",
"checkout",
"purchase"
)
library(dplyr)
session_funnel <- df %>%
filter(EventType %in% funnel_steps) %>%
group_by(SessionID) %>%
summarise(
step = max(match(EventType, funnel_steps)),
.groups = "drop"
)
funnel_counts <- data.frame(
step = funnel_steps,
value = sapply(seq_along(funnel_steps), function(i)
sum(session_funnel$step >= i)
)
)
library(plotly)
plot_ly(
funnel_counts,
type = "funnel",
y = ~step,
x = ~value
)
transitions <- df %>%
filter(!is.na(EventType), EventType != "") %>%
group_by(SessionID) %>%
mutate(next_event = lead(EventType)) %>%
ungroup() %>%
filter(!is.na(next_event)) %>%
count(EventType, next_event, name = "value")
nodes <- data.frame(
name = unique(c(transitions$EventType, transitions$next_event))
)
nodes$id <- seq_len(nrow(nodes)) - 1
links <- transitions %>%
left_join(nodes, by = c("EventType" = "name")) %>%
rename(source = id) %>%
left_join(nodes, by = c("next_event" = "name")) %>%
rename(target = id)
plot_ly(
type = "sankey",
node = list(
label = nodes$name
),
link = list(
source = links$source,
target = links$target,
value = links$value
)
)
transitions <- df %>%
filter(!is.na(EventType), EventType != "") %>%
group_by(SessionID) %>%
mutate(next_event = lead(EventType)) %>%
ungroup() %>%
filter(!is.na(next_event)) %>%
count(EventType, next_event, name = "value")
nodes <- data.frame(
name = unique(c(transitions$EventType, transitions$next_event))
)
nodes$id <- seq_len(nrow(nodes)) - 1
links <- links %>%
group_by(source) %>%
mutate(value = value / sum(value)) %>%
ungroup()
plot_ly(
type = "sankey",
node = list(
label = nodes$name
),
link = list(
source = links$source,
target = links$target,
value = links$value
)
)
quarto render
